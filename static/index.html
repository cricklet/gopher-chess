<style>
    body {
        background-color: #eee;
    }
    #container {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .danger.dark {background-color: #dacaca;}
    .danger.light {background-color: #faeaea;}
    .row {
        font-size: 4rem;
        height: 1em;
        display:flex;
    }
    span {
        display: inline-block;
        text-align: center;
        grid-area:1/1;
    }
    .square{
        cursor:default;
        display: grid;
        width: 1em;
        height: 1em;
        line-height: 1em;
    }
    .dark {background-color: #777;}
    .light {background-color: #aaa;}
    .selected.dark {background-color: #88a}
    .selected.light {background-color: #bbd}
    .dark:has(.potential):hover {background-color: #779;}
    .light:has(.potential):hover {background-color: #aac;}
    .potential {
        z-index: 9;
    }
    .potential.white {
        filter:invert(90%);
    }
    .potential::after {
        content: "â¬¤";
        font-size: 0.4em;
    }
    .potential {cursor:pointer;}
    .clickable {cursor:pointer;}
    .dark.clickable:hover {background-color: #779;}
    .light.clickable:hover {background-color: #aac;}
    .piece.white {
        filter:invert(90%);
    }
    .piece {
        width: 1em; height: 1em;
        background-origin: content-box;
        background-repeat: no-repeat;
        background-position: center;
        padding: 4px;
        box-sizing: border-box;
    }
    .rook {
        background-image: url('chess-rook-solid.svg');
    }
    .king {
        background-image: url('chess-king-solid.svg');
    }
    .knight {
        background-image: url('chess-knight-solid.svg');
    }
    .pawn {
        background-image: url('chess-pawn-solid.svg');
    }
    .queen {
        background-image: url('chess-queen-solid.svg');
    }
    .bishop {
        background-image: url('chess-bishop-solid.svg');
    }

</style>
<script>
    function click(i, j) {
        
    }

    PIECE_CLASS_MAP = {
        'r': ['b', 'rook'],
        'n': ['b', 'knight'],
        'b': ['b', 'bishop'],
        'q': ['b', 'queen'],
        'k': ['b', 'king'],
        'p': ['b', 'pawn'],
        'R': ['w', 'rook'],
        'N': ['w', 'knight'],
        'B': ['w', 'bishop'],
        'Q': ['w', 'queen'],
        'K': ['w', 'king'],
        'P': ['w', 'pawn'],
    }

    PLAYER_PIECE_MAP = {
        'w': new Set(['R', 'N', 'B', 'Q', 'K', 'P']),
        'b': new Set(['r', 'n', 'b', 'q', 'k', 'p'])
    }


    function rankFromChar(c) {
        return parseInt(c) - 1
    }

    function fileFromChar(c) {
        return ["a", "b", "c", "d", "e", "f", "g", "h",].indexOf(c)
    }

    function fileRankFromString(location) {
        return [fileFromChar(location[0]), rankFromChar(location[1])]
    }

    function parseFenBoardString(fen) {
        let board = [
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
            [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ']
        ]
        let rankIndex = 7
        let fileIndex = 0
        for (let c of fen) {
            if (c == '/') {
                if (fileIndex != 8) {
                    throw Error("couldn't parse " + fen)
                }
                rankIndex--
                fileIndex = 0
                continue
            }
            indicesToSkip = parseInt(c)
            if (!isNaN(indicesToSkip)) {
                fileIndex += indicesToSkip
                continue  
            }
            board[fileIndex][rankIndex] = c
            fileIndex ++
        }

        return board
    }

    async function update(board, selectedFileRank, player, availableMoves) {
        console.log(availableMoves)
        const containerEl = document.getElementById('container')
        containerEl.innerHTML = ''

        for (const [rank, row] of board.entries()) {
            const rowEl = document.createElement('div')
            rowEl.classList.add('row')
            containerEl.appendChild(rowEl)

            for (const [file, c] of row.entries()) {
                const spanEl = document.createElement('span')
                spanEl.classList.add('square')

                if ((rank + file) % 2 == 1) spanEl.classList.add('dark')
                else spanEl.classList.add('light')

                spanEl.onclick=() => click(rank, file)

                if (selectedFileRank && selectedFileRank[1] == rank && selectedFileRank[0] == file) {
                    spanEl.classList.add('selected')
                }
                
                const pieceClasses = PIECE_CLASS_MAP[c]
                if (pieceClasses) {
                    const pieceEl = document.createElement('span')
                    for (const c of pieceClasses) {
                        pieceEl.classList.add(c)
                    }
                    pieceEl.classList.add('piece')

                    spanEl.appendChild(pieceEl)

                    if (PLAYER_PIECE_MAP[player].has(c) && selectedFileRank == null) {
                        spanEl.classList.add('clickable')
                    }
                }

                if (availableMoves[file] && availableMoves[file][rank]) {
                    const potentialEl = document.createElement('span')
                    potentialEl.classList.add('potential')
                    potentialEl.classList.add(player)
                    spanEl.appendChild(potentialEl)
                }
                rowEl.appendChild(spanEl)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => { 
        document.body.addEventListener('keydown', () => {
            // We will send:
            // {
            //   "selection": ".."
            //   "move": ".."
            // }

        })
        
        let socket = new WebSocket("ws://0.0.0.0:8002/ws");

        function send(obj) {
            const message = JSON.stringify(obj)
            console.log("sending", message)
            socket.send(message)
        }

        socket.onopen = () => {
            let fen = window.location.pathname.slice(1)
            if (fen == 'startpos' || fen.length < 1) {
                fen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1'
            }
            send({NewFen: fen})
        };

        socket.onmessage = event => {
            data = JSON.parse(event.data)
            let board = parseFenBoardString(data.FenBoardString)
            update(board, null, 'w', [])

            console.log(board)
            // Have the server send:
            // position <fen-string>
            // history e2e4 e5e7
        }

        socket.onclose = event => {
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };
    })
</script>
<div id="container"></div>